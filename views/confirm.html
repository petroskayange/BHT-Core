<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap/bootstrap.min.js"></script>
<script src="/assets/js/moment.js"></script>

<script src="/apps/ART/assets/js/fast_track_alert.js"></script>

<script src="/assets/js/generic_ajaxrequest.js"></script>
<link rel="stylesheet" href="/assets/css/bootstrap/bootstrap.min.css" />
<!-- <rel="stylesheet" href="/assets/css/maindashboard/headefooter.css">  -->
<link rel="stylesheet" href="/assets/css/custom.css" />
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/moment.js"></script>
<script src="/assets/js/bmi.js"></script>
<script src="/assets/js/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/js/alertifyjs/alertify.js"></script>
<script
  type="text/javascript"
  src="/assets/js/does_connection_exist.js"
></script>

<script src="/assets/js/httpUtils.js"></script>
<script src="/assets/js/uiUtils.js"></script>
<script src="/assets/js/GlobalProperty.js"></script>

<script type="text/javascript" src="/assets/anc/js/initializeItems.js"></script>

<link
  rel="stylesheet"
  href="/assets/css/alertifyjs/css/alertify.css"
  type="text/css"
/>
<style>
  * {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  .demographics-table {
    display: table;
    width: 100%;
    height: 120px;
  }

  .demographics-table-row {
    display: table-row;
  }

  .demographics-table-cell {
    display: table-cell;
    border-style: solid;
    border-width: 1px;
    box-shadow: 5px 10px #888888;
    padding: 20px;
  }

  .info-table {
    display: table;
    width: 100%;
    margin-top: 10px;
    border-collapse: separate;
    border-spacing: 10px;
  }

  .info-table-row {
    display: table-row;
  }

  .info-table-cell {
    display: table-cell;
    border: 1px solid black;
    border-radius: 5px;
    box-shadow: 0 8px 18px 0 rgba(0, 0, 0, 0.2);
    transition: 0.3s;
    height: 230px !important;
    width: 23%;
    display: table-cell;
  }

  .section-badge {
    margin: 10px 10px 5px 10px;
    width: 92%;
    padding-left: 10px;
    background-color: slategray;
    vertical-align: center;
    border-style: solid;
    border-width: 0px 0px 1px 0px;
    color: #fff;
  }

  .section-body {
    margin: 10px 10px 5px 10px;
    width: 92%;
    padding-left: 10px;
    height: 80%;
    background-color: white;
  }

  #demographics-addresses th {
    font-size: 12px;
  }

  .buttonsDIV {
    background-color: #333333;
    display: block;
    height: 80px;
    position: absolute;
    bottom: 1px;
    width: 98.7%;
    z-index: 10;
  }

  .buttonsDIV button {
    margin: 5px 0px 0px;
    margin-right: 10px;
    height: 60px;
    font-size: 2rem;
  }

  .blue {
    border: 1px solid #7eb9d0;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
    font-size: 28px;
    font-family: helvetica;
    padding: 10px 10px 10px 10px;
    text-decoration: none;
    display: inline-block;
    text-shadow: -1px -1px 0 rgba(0, 0, 0, 0.3);
    font-weight: bold;
    color: #ffffff;
    background-color: #a7cfdf;
    background-image: -webkit-gradient(
      linear,
      left top,
      left bottom,
      from(#a7cfdf),
      to(#23538a)
    );
    background-image: -webkit-linear-gradient(top, #a7cfdf, #23538a);
    background-image: -moz-linear-gradient(top, #a7cfdf, #23538a);
    background-image: -ms-linear-gradient(top, #a7cfdf, #23538a);
    background-image: -o-linear-gradient(top, #a7cfdf, #23538a);
    background-image: linear-gradient(to bottom, #a7cfdf, #23538a);
    filter: progid: DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#a7cfdf, endColorstr=#23538a);
  }

  .red {
    border: 1px solid #ff0011;
    background-image: linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -o-linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -moz-linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -webkit-linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -ms-linear-gradient(
      bottom,
      rgb(255, 0, 17) 0%,
      rgb(255, 0, 17) 100%
    );
    background-image: -webkit-gradient(
      color-stop(0, rgb(255, 0, 17)),
      color-stop(1, rgb(255, 0, 17))
    ) !important;
    background-color: #5c0707;

    border: 1px solid #450111;
    background-color: #77021d;
    background-image: -webkit-gradient(
      linear,
      left top,
      left bottom,
      from(#77021d),
      to(#3a000d)
    );
    background-image: -webkit-linear-gradient(top, #77021d, #3a000d);
    background-image: -moz-linear-gradient(top, #77021d, #3a000d);
    background-image: -ms-linear-gradient(top, #77021d, #3a000d);
    background-image: -o-linear-gradient(top, #77021d, #3a000d);
    background-image: linear-gradient(to bottom, #77021d, #3a000d);
    filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#77021d, endColorstr=#3a000d);
    color: #fff;
  }

  .info-tables {
    width: 99%;
    border-collapse: collapse;
  }
  td,
  th {
    padding: 3px;
  }
  .info-tables td {
    border-width: 0px 0px 1px 0px;
    border-style: solid;
  }

  #dankPrompt button {
    padding: 1%;
    font-size: 1.3em;
    width: 20%;
    background-color: #303031;
    border-radius: 4px;
  }

/* ... Address cover ............. */
#address-confirmation-table {
  width: 100%;
}

#address-confirmation-table th {
  font-size: 20px;
  font-weight: bold;
  padding-bottom: 40px;
  text-align: center;
}

#address-confirmation-table td {
  border-style: solid;
  border-width: 0px 0px 1px 0px;
}

#address-confirmation {
  display: none;
  background-color: #F4F4F4;
  border: 2px solid #E0E0E0;
  border-radius: 15px;
  height: 75%;
  padding: 5px;
  position: absolute;
  top: 10px;
  width: 97%;
  left: 1%;
  z-index: 991;
}

#address-confirmation-cover {
  display: none;
  position: absolute;
  background-color: black;
  width: 100%;
  height: 102%;
  left: 0%;
  top: 0%;
  z-index: 990;
  opacity: 0.65;
}

#address-confirmation-buttons {
  bottom: 15px;
  width: 99%;
  position: absolute;
}

.address-confirmation-button {
  height: 100px;
  width: 48%;
  font-weight: bold;
  font-size: 15px;
}

#green-btn:hover {
  border: 1px solid #224b09;

  background-color: #36780f;

  background-image: -webkit-gradient(linear, left top, left bottom, from(#36780f), to(#005900));

  background-image: -webkit-linear-gradient(top, #36780f, #005900);

  background-image: -moz-linear-gradient(top, #36780f, #005900);

  background-image: -ms-linear-gradient(top, #36780f, #005900);

  background-image: -o-linear-gradient(top, #36780f, #005900);

  background-image: linear-gradient(to bottom, #36780f, #005900);

  filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#36780f, endColorstr=#005900);
  }

#green-btn {
  border: 1px solid #34740e;

  -webkit-border-radius: 3px;

  -moz-border-radius: 3px;

  border-radius: 3px;

  margin-left: 20px;

  font-size: 28px;

  font-family: arial, helvetica, sans-serif;

  padding: 10px 10px 10px 10px;

  text-decoration: none;

  display: inline-block;

  text-shadow: -1px -1px 0 rgba(0, 0, 0, 0.3);

  font-weight: bold;

  color: #FFFFFF;

  background-color: #4ba614;

  background-image: -webkit-gradient(linear, left top, left bottom, from(#4ba614), to(#008c00));

  background-image: -webkit-linear-gradient(top, #4ba614, #008c00);

  background-image: -moz-linear-gradient(top, #4ba614, #008c00);

  background-image: -ms-linear-gradient(top, #4ba614, #008c00);

  background-image: -o-linear-gradient(top, #4ba614, #008c00);

  background-image: linear-gradient(to bottom, #4ba614, #008c00);
  }

#blue-btn:hover {
  border: 1px solid #5ca6c4;

  background-color: #82bbd1;

  background-image: -webkit-gradient(linear, left top, left bottom, from(#82bbd1), to(#193b61));

  background-image: -webkit-linear-gradient(top, #82bbd1, #193b61);

  background-image: -moz-linear-gradient(top, #82bbd1, #193b61);

  background-image: -ms-linear-gradient(top, #82bbd1, #193b61);

  background-image: -o-linear-gradient(top, #82bbd1, #193b61);

  background-image: linear-gradient(to bottom, #82bbd1, #193b61);

  filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#82bbd1, endColorstr=#193b61);
  }

#blue-btn {
  border: 1px solid #7eb9d0;

  -webkit-border-radius: 3px;

  -moz-border-radius: 3px;

  border-radius: 3px;

  font-size: 28px;

  font-family: arial, helvetica, sans-serif;

  padding: 10px 10px 10px 10px;

  text-decoration: none;

  display: inline-block;

  text-shadow: -1px -1px 0 rgba(0, 0, 0, 0.3);

  font-weight: bold;

  color: #FFFFFF;

  background-color: #a7cfdf;

  background-image: -webkit-gradient(linear, left top, left bottom, from(#a7cfdf), to(#23538a));

  background-image: -webkit-linear-gradient(top, #a7cfdf, #23538a);

  background-image: -moz-linear-gradient(top, #a7cfdf, #23538a);

  background-image: -ms-linear-gradient(top, #a7cfdf, #23538a);

  background-image: -o-linear-gradient(top, #a7cfdf, #23538a);

  background-image: linear-gradient(to bottom, #a7cfdf, #23538a);

  filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#a7cfdf, endColorstr=#23538a);
  }

/* ... Address cover ends ............. */

#nextTask {
  font-size: 12px;
  color: black;
  font-weight: bold;
}

.filing-number-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 115px;
}
.high {
  background: red;
}
</style>

<script>
const HIV_PROGRAM_ID = 1
var global_property = GlobalProperty({
  authToken: sessionStorage.authorization,
  path: apiProtocol + '://' + apiURL + ':' + apiPort + '/api/v1'
});

  var apiPath = `${apiProtocol}://${apiURL}:${apiPort}/api/v1`;
  var patientDead = false;
  function buildInfoBoxes() {
    var infoBox = document.getElementsByClassName("info-table")[0];
    
    if(sessionStorage.programID == '1' || sessionStorage.programID == '12' || sessionStorage.programID == '21') {
      var cells = [
        "Patient identifiers", "Alert(s)",
        "labs", "Program info", 
        "Outcome", "Guardian(s)"
      ];
    }else{
      var cells = [
        "Patient identifiers"
      ];
    }

    var count = 0;
    var row = document.createElement("div");
    row.setAttribute("class", "info-table-row");
    infoBox.appendChild(row);

    for (var i = 0; i < cells.length; i++) {
      if (count == 3) {
        row = document.createElement("div");
        row.setAttribute("class", "info-table-row");
        infoBox.appendChild(row);
        count = 0;
      }

      var cell = document.createElement("div");
      cell.setAttribute("class", "info-table-cell");

      var header = document.createElement("div");
      header.setAttribute("class", "section-badge");
      header.innerHTML = cells[i].toUpperCase();
      cell.appendChild(header);

      var body = document.createElement("div");
      body.setAttribute("class", "section-body");
      body.setAttribute("id", "section-body-" + i);
      cell.appendChild(body);

      row.appendChild(cell);

      count++;
    }

    insertData();
  }

  function insertData() {
    var url_string = window.location;
    var url = new URL(url_string);
    var patient_id = url.searchParams.get("patient_id");
    var person_id = url.searchParams.get("person_id");
    if (person_id != null) {
      getClientbyID(person_id);
    } else if (patient_id != null) {
      patient_id = patient_id.replace(/-/g, "");
      getClient(patient_id);
    }
  }

  function getClient(patient_id) {
    var dde_status = "";
    var url = "";
    if (sessionStorage.dde_enabled === "true") {
      url = apiProtocol + "://" + apiURL + ":" + apiPort;
      url += "/api/v1/dde/patients/find_by_npid?npid=" + patient_id;
      url += "&program_id=" + sessionStorage.programID;
    }else {
      url =
      apiProtocol +
      "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/search/patients/by_npid?npid=" +
      patient_id;
    }


    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        if (sessionStorage.dde_enabled === "true") {
          var remotes = JSON.parse(this.responseText)["remotes"];
          var locals = JSON.parse(this.responseText)["locals"];
          if (remotes.length > 1 || locals.length > 1) {
            location.href = "/views/npid_duplicates.html?health_id=" + patient_id;
          }else if (locals.length >= 1 && remotes.length >=1) {
            location.href = "/views/npid_duplicates.html?health_id=" + patient_id;
          } else if (locals.length == 1) {
            populatePatient(locals[0], locals[0]);
          } else {
            noPatient();
          }
        }else {
          var obj = JSON.parse(this.responseText)[0];
          var obj_2 = JSON.parse(this.responseText)[0];
          if (JSON.parse(this.responseText).length > 1) {
            location.href = "/views/duplicates.html?health_id=" + patient_id;
          } else if (JSON.parse(this.responseText).length == 1) {
            populatePatient(obj, obj_2);
          } else {
            noPatient();
          }     
        }
        
      } else if (this.status == 204) {
        window.location.href = "/";
      }else if (this.status == 422) {
        var f = JSON.parse(this.responseText);
        //sessionStorage.patientID = f.patient_id;
        sessionStorage.patientID = f.entity.patient_id;
        window.location.href = "/views/patient/edit_demographics.html";
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }

  function getClientbyID(person_id) {
    var url =
      apiProtocol +
      "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/patients/" +
      person_id;

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        var obj = JSON.parse(this.responseText);
        var obj_2 = JSON.parse(this.responseText);
        populatePatient(obj, obj_2);
      } else if (this.status == 204) {
        window.location.href = "/";
      }else if (this.status == 422) {
        var f = JSON.parse(this.responseText);
        sessionStorage.patientID = f.patient_id;
        window.location.href = "/views/patient/edit_demographics.html";
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }
  function populatePatient(obj, obj_2) {
    var patient = obj;
    obj = obj["person"];
    patient_id = patient["patient_id"];
    sessionStorage.patientID = patient_id;

    var names = obj["names"][0];
    var client_name = document.getElementById("client-name");
    client_name.innerHTML = names["given_name"] + " " + names["family_name"];
    sessionStorage.given_name = names["given_name"];
    sessionStorage.family_name = names["family_name"];
    var dob = document.getElementById("client-dob");
    dob.innerHTML =
      "&nbsp;(" + moment(obj["birthdate"]).format("DD/MMM/YYYY") + ")";

    var gender = obj["gender"] == "M" ? "male.gif" : "female.gif";
    var icon = document.getElementById("gender-icon-container");
    var img = document.createElement("img");
    img.setAttribute("src", "/assets/images/" + gender);
    icon.appendChild(img);

    if (obj["addresses"].length > 0) {
      var ancestry_district = document.getElementById("ancestry-district");
      var ancestry_ta = document.getElementById("ancestry-ta");
      var ancestry_village = document.getElementById("ancestry-village");
      ancestry_district.innerHTML = obj["addresses"][0]["county_district"];
      ancestry_ta.innerHTML = obj["addresses"][0]["county_district"];
      ancestry_village.innerHTML = obj["addresses"][0]["neighborhood_cell"];

      var current_district = document.getElementById("current-district");
      var current_ta = document.getElementById("current-ta");
      var current_village = document.getElementById("current-village");
      current_district.innerHTML = obj["addresses"][0]["state_province"];
      current_ta.innerHTML = obj["addresses"][0]["township_division"];
      current_village.innerHTML = obj["addresses"][0]["city_village"];
    }

    if(sessionStorage.programID == '1') 
      checkAddressValidity(obj['addresses']);
    

    var roundedAge = Math.round(moment().diff(obj["birthdate"], "years", true));
    sessionStorage.patientAge = roundedAge;
    sessionStorage.patientGender = obj["gender"];
    sessionStorage.patientDOB = moment(obj["birthdate"]).format("DD/MMM/YYYY");
    //sessionStorage.sessionDate = moment().format("YYYY-MM-DD");
    getHeight(patient_id);
    getWeight(patient_id);
    sessionStorage.patientID = patient_id;
    
    buildIdentifiers(patient["patient_identifiers"]);
    if(sessionStorage.programID == '1') {
      showOrders();
      buildStates(obj, patient_id);
      var orders = obj_2;
      buildOrders(orders["orders"]);
      buildProgramInfo(patient_id);
      buildRelationShips(patient_id);
      buildAlerts(patient_id);
    }else if (sessionStorage.programID == '12' || sessionStorage.programID == '21'){
      buildProgramInfo(patient_id);
      buildAlerts(patient_id);
      buildStates(obj, patient_id);
    }
    

    var gender = null;
    if (sessionStorage.patientGender === "F") {
      gender = "female";
    } else if (sessionStorage.patientGender === "M") {
      gender = "male";
    }
    var bmindex =
      (sessionStorage.currentWeight /
        sessionStorage.currentHeight /
        sessionStorage.currentHeight) *
      10000;
    bmindex = Math.round(bmindex * 10) / 10;
    getBMIResult(gender, roundedAge, bmindex);
  }

  function getHeight(patient_id) {
    var url = apiProtocol + "://" + apiURL + ":" + apiPort;
    url += "/api/v1/observations?person_id=" + patient_id + "&concept_id=5090";
    url +=
      "&date=" +
      moment(new Date(sessionStorage.sessionDate)).format("YYYY-MM-DD");
    url += "&page_size=1";

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        var obj = JSON.parse(this.responseText);
        if (obj.length > 0) {
          sessionStorage.currentHeightObsID = obj[0].obs_id;
          var height = parseInt(obj[0].value_numeric);
          if (height > 0) {
            sessionStorage.currentHeight = height;
          } else if (obj[0].value_text.length > 0) {
            sessionStorage.currentHeight = parseInt(obj[0].value_text);
          } else {
            sessionStorage.currentHeight = 0;
          }
        }
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }
  function getWeight(patient_id) {
    var url = apiProtocol + "://" + apiURL + ":" + apiPort;
    url += "/api/v1/observations?person_id=" + patient_id + "&concept_id=5089";
    url +=
      "&date=" +
      moment(new Date(sessionStorage.sessionDate)).format("YYYY-MM-DD");
    url += "&page_size=1";

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
        var obj = JSON.parse(this.responseText);
        if (obj.length > 0) {
          var weight = parseFloat(obj[0].value_numeric);
          if (weight > 0) {
            sessionStorage.currentWeight = weight;
          } else if (obj[0].value_text.length > 0) {
            sessionStorage.currentWeight = parseFloat(obj[0].value_text);
          } else {
            sessionStorage.currentWeight = 0;
          }
        }
      }
    };
    xhttp.open("GET", url, true);
    xhttp.setRequestHeader(
      "Authorization",
      sessionStorage.getItem("authorization")
    );
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }
  function buildIdentifiers(identifiers) {
    var identifiersHash = {};
    for (var i = 0; i < identifiers.length; i++) {
      if (identifiers[i]["identifier_type"] == 3) {
        identifiersHash["NPID"] = formatIdentifier(
          identifiers[i]["identifier"]
        );
      } else if (identifiers[i]["identifier_type"] == 4) {
        if(sessionStorage.programID == '1')
          identifiersHash["ARV#"] = identifiers[i]["identifier"];

      } else if (identifiers[i]["identifier_type"] == 17) {
        identifiersHash["Active filing#"] = formatIdentifier(
          identifiers[i]["identifier"]
        );
      } else if (identifiers[i]["identifier_type"] == 18) {
        identifiersHash["Archived filing#"] = formatIdentifier(
          identifiers[i]["identifier"]
        );
      }
    }

    var table = document.createElement("table");
    table.setAttribute("class", "info-tables");

    var url = window.location.href;
    url = new URL(url);
    var scanned_id = url.searchParams.get("patient_id");

    for (identifier in identifiersHash) {
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.innerHTML = identifier;
      tr.appendChild(td);

      var td = document.createElement("td");
      td.innerHTML = identifiersHash[identifier];
      
      if(identifier.match(/filing/i)){
        td.setAttribute('id', 'filing-number');
      }

      tr.appendChild(td);
      table.appendChild(tr);

      if(sessionStorage.dde_enabled === 'true') {
        if(identifier.toUpperCase() == 'NPID' && identifiersHash[identifier].length > 0) {
          var returned_id = identifiersHash[identifier].toUpperCase().replace(/-/g, "");
          if(scanned_id) {
            if(scanned_id.toUpperCase().replace(/-/g, "") != returned_id && scanned_id.length != 6) {
              document.location = '/views/print/npid.html?identifier=' + returned_id;
            }
          }
        }
      }
    }  
    var container = document.getElementById("section-body-0");
    container.appendChild(table);
  }

  function buildStates(identifiers, patient_id) {
    var identifiersHash = {};
    var url =
      sessionStorage.apiProtocol + "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/programs/" + sessionStorage.programID + "/patients/" +
      patient_id;
    var req = new XMLHttpRequest();
    req.onreadystatechange = function() {
      if (this.readyState == 4) {
        if (this.status == 200) {
          var results = JSON.parse(this.responseText);

          identifiersHash["Current Outcome"] =
            results.current_outcome !== "N/A"
              ? results.current_outcome
              : "No Outcome Available";buildInfoBoxes
          var table = document.createElement("table");
          table.setAttribute("class", "info-tables");

          for (identifier in identifiersHash) {
            var tr = document.createElement("tr");
            var td = document.createElement("td");
            td.innerHTML = identifier;
            tr.appendChild(td);

            var td = document.createElement("td");
            td.innerHTML = identifiersHash[identifier];
            tr.appendChild(td);
            table.appendChild(tr);
          }

          var container = document.getElementById("section-body-4");
          container.appendChild(table);
        }
      }
    };
    try {
      req.open("GET", url, true);
      req.setRequestHeader(
        "Authorization",
        sessionStorage.getItem("authorization")
      );
      req.send(null);
    } catch (e) {}
  }
  function buildOrders(identifiers) {
    if (identifiers == undefined) {
      identifiers = 0;
    }
    var table = document.createElement("table");
    table.setAttribute("class", "info-tables");

    var tbody = document.createElement('tbody');
    tbody.setAttribute('id','vl-orders');
    table.appendChild(tbody);

    var container = document.getElementById("section-body-2");
    container.appendChild(table);
  }
  function buildRelationShips(patient_id) {
    var url =
      sessionStorage.apiProtocol + "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/people/" +
      patient_id +
      "/relationships";
    var req = new XMLHttpRequest();
    var table = document.createElement("table");
    table.setAttribute("class", "info-tables");
    var container = document.getElementById("section-body-5");
    container.appendChild(table);
    req.onreadystatechange = function() {
      if (this.readyState == 4) {
        if (this.status == 200) {
          var results = JSON.parse(this.responseText);
          for (var x = 0; x < results.length; x++) {
            var tr = document.createElement("tr");
            var td = document.createElement("td");
            td.innerHTML =
              results[x].relation.names[0].given_name +
              " " +
              results[x].relation.names[0].family_name;
            tr.appendChild(td);
            var td = document.createElement("td");
            td.innerHTML = results[x].type.b_is_to_a;
            tr.appendChild(td);
            table.appendChild(tr);
          }
        }
      }
    };
    try {
      req.open("GET", url, true);
      req.setRequestHeader(
        "Authorization",
        sessionStorage.getItem("authorization")
      );
      req.send(null);
    } catch (e) {}
  }

  function buildAlerts(patient_id) {
    var url =
      sessionStorage.apiProtocol + "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/observations?person_id=" +
      patient_id +
      "&concept_id=7755";
    var req = new XMLHttpRequest();
    var table = document.createElement("table");
    table.setAttribute("class", "info-tables");
    var container = document.getElementById("section-body-1");
    container.appendChild(table);
    req.onreadystatechange = function() {
      if (this.readyState == 4) {
        if (this.status == 200) {
          var results = JSON.parse(this.responseText);
          var sideEffects = 0;
          if (results.length > 0) {
            for (var index = 0; index < results.length; index++) {
              try {
                if (results[index].children[0].value_coded == 1065) {
                  sideEffects++;
                }
              }catch(e) {

              }
              
            }
            var tr = document.createElement("tr");
            var td = document.createElement("td");
            td.innerHTML = "Patient Has " + sideEffects + " Side Effect(s)";
            td.setAttribute("colspan", 2);
            tr.appendChild(td);
            table.appendChild(tr);
          }
          if (sessionStorage.bmiResult !== "null") {
            var tr = document.createElement("tr");
            var td = document.createElement("td");
            td.innerHTML = "Patient Weight is";
            tr.appendChild(td);
            var td = document.createElement("td");
            td.innerHTML = sessionStorage.bmiResult;
            tr.appendChild(td);
            table.appendChild(tr);
          }
        }
      }
    };
    try {
      req.open("GET", url, true);
      req.setRequestHeader(
        "Authorization",
        sessionStorage.getItem("authorization")
      );
      req.send(null);
    } catch (e) {}
    buildDefaulter(patient_id, table);
  }
  function buildDefaulter(patient_id, table) {
    var url =
      sessionStorage.apiProtocol + "://" +
      apiURL +
      ":" +
      apiPort +
      "/api/v1/observations?person_id=" +
      patient_id +
      "&concept_id=6828";
    var req = new XMLHttpRequest();
    req.onreadystatechange = function() {
      if (this.readyState == 4) {
        if (this.status == 200) {
          var results = JSON.parse(this.responseText);
          if (results.length > 0) {
            var tr = document.createElement("tr");
            var td = document.createElement("td");
            td.innerHTML = "Patient Is a Defaulter";
            td.setAttribute("colspan", 2);
            tr.appendChild(td);
            table.appendChild(tr);
          }
        }
      }
    };
    try {
      req.open("GET", url, true);
      req.setRequestHeader(
        "Authorization",
        sessionStorage.getItem("authorization")
      );
      req.send(null);
    } catch (e) {}
  }

  function buildProgramInfo(patient_id) {
    if (sessionStorage.programID === "12"){

      document.getElementById("section-body-3").innerHTML +=
        "<table class='info-tables'><tr><td style=\"color:blue; font-weight:bold;\">Next Appointment Date:</td><td id='nextAptDate'>N/A</td>" +
        "</tr><tr><td>Gestation Age:</td><td id='gest_age'>N/A</td></tr><tr>" +
        "<td style=\"color:blue; font-weight:bold;\">Date of LMP:</td><td id='date_of_lmp'>N/A</td></tr>" +
        "<tr><td style=\"color:green; font-weight:bold;\">EDOD:</td><td id='edod'>N/A</td></tr</table>" +
        "<tr><td style=\"color:green; font-weight:bold;\">Next task:</td><td id='nextTask'>None</td></tr</table>";
      //document.getElementById("section-body-3").innerHTML +=
        //"<table class='info-tables'><tr><td style=\"color:blue; font-weight:bold;\">Next Appointment Date:</td><td id='nextAptDate'>N/A</td>" +
        //"</tr></table>";
      populateNextAppointmentDate({ elementToUse: "nextAptDate" }, patient_id);
      populateNextTask(patient_id);
      setTimeout(function(){
        populateANCProgramInfo()
      }, 3000);
      
    }else if (sessionStorage.programID === "1"){
      document.getElementById("section-body-3").innerHTML +=
        "<table class='info-tables'><tr><td style=\"color:blue; font-weight:bold;\">Next Appointment Date:</td><td id='nextAptDate'>N/A</td>" +
        "</tr><tr><td>ART Duration:</td><td id='artDuration'>N/A</td></tr><tr><td style=\"color:blue; font-weight:bold;\">ON FAST TRACK:</td><td id='onFastTrack'>N/A</td></tr><tr><td style=\"color:green; font-weight:bold;\">Next task:</td><td id='nextTask'>None</td></tr</table>";
      populateNextAppointmentDate({ elementToUse: "nextAptDate" }, patient_id);
      populateArtDuration({ elementToUse: "artDuration" }, patient_id);
      populateOnFastTrack({ elementToUse: "onFastTrack" }, patient_id);
      populateNextTask(patient_id);

    }else if (sessionStorage.programID === "21"){
      document.getElementById("section-body-3").innerHTML +=
        "<table class='info-tables'><tr><td style=\"color:blue; font-weight:bold;\">Next Appointment Date:</td><td id='nextAptDate'>N/A</td>" +
        "</tr><tr><td style=\"color:green; font-weight:bold;\">Next task:</td><td id='nextTask'>None</td></tr</table>";
      populateNextAppointmentDate({ elementToUse: "nextAptDate" }, patient_id);
      populateNextTask(patient_id);
    }
  }

  function populateNextAppointmentDate(options, patient_id) {
    GET(
      {
        url:
          apiPath +
          "/observations?person_id=" +
          patient_id +
          "&concept_id=5096",
        async: true,
        headers: {
          Authorization: sessionStorage.getItem("authorization")
        }
      },
      {},
      function(data) {
        var date = "";
        try {
          date = moment(data[0].value_datetime).format("DD/MMM/YYYY");
        } catch (e) {
          date = "Not Available";
        }
        var el = document.getElementById(options.elementToUse);
        el.innerText = date;
        el.style.color = "blue";
      },
      function(error, status) {
        if (status === 404) {
          var el = document.getElementById(options.elementToUse);
          el.innerText = "Not Available";
          el.style.color = "blue";
        } else {
          console.error(error);
        }
      }
    );
  }

  function populateArtDuration(options, patient_id) {
    GET(
      {
        url:
          apiPath +
          "/programs/" +
          sessionStorage.getItem("programID") +
          "/patients/" +
          patient_id,
        async: true,
        headers: {
          Authorization: sessionStorage.getItem("authorization")
        }
      },
      {},
      function(data) {
        if (data.art_duration !== "N/A") {
          document.getElementById(options.elementToUse).innerText =
            calculateMonthsOnART(data.art_start_date) + " month(s)";
        }
      },
      function(error, status) {
        console.error(error);
      }
    );
  }

  function populateOnFastTrack(options, patient_id) {
    GET(
      {
        url:
          apiPath +
          "/on_fast_track?person_id=" +
          patient_id +
          "&date=" +
          sessionStorage.getItem("sessionDate"),
        async: true,
        headers: {
          Authorization: sessionStorage.getItem("authorization")
        }
      },
      {},
      function(data) {
        if (data["continue FT"] === true) {
          var el = document.getElementById(options.elementToUse);
          el.innerText = "YES";
          el.style.color = "blue";
          setUpFTalert(document.getElementById("continue"));
        } else {
          var el = document.getElementById(options.elementToUse);
          el.innerText = "NO";
          el.style.color = "blue";
        }
      },
      function(error, status) {
        console.error(error);
      }
    );
  }

  function populateANCProgramInfo(){

    gestation = document.getElementById("gest_age");
    
    lmp = document.getElementById("date_of_lmp");
    
    edod = document.getElementById('edod');
    
    var url = apiProtocol + '://' + apiURL + ':' + apiPort 

    url += '/api/v1/programs/'+programID+'/patients/' + sessionStorage.patientID;

    var req = new XMLHttpRequest();

    req.onreadystatechange = function () {

      if (this.readyState == 4) {

        if (this.status == 200) {
          var results = JSON.parse(this.responseText);

          if (results.gestation){
            
            sessionStorage.gestation = results.gestation; 

            gestation.innerHTML = sessionStorage.gestation + " weeks";
          
          }

          if (results.date_of_lnmp){

            sessionStorage.dateOfLMP = results.date_of_lnmp;

            lmp.innerHTML = moment(sessionStorage.dateOfLMP).format("DD/MMM/YYYY");

          }

          if (results.edod){

            sessionStorage.patientEDOD = results.edod;

            edod.innerHTML = moment(sessionStorage.patientEDOD).format("DD/MMM/YYYY");
          
          }
          
          sessionStorage.fundusByLMP = results.fundus;  
          
          sessionStorage.totalANCVisits = results.anc_visits;
          
          sessionStorage.currentOutcome =  results.current_outcome;
      
        }
    
      }
  
    };
  
    try {
    
      req.open('GET', url, true);
    
      req.setRequestHeader('Authorization', sessionStorage.getItem('authorization'));
    
      req.send(null);
  
    } catch (e) {
  
      console.log(e);

    }
  }
</script>

<div class="demographics-table">
  <div class="demographics-table-row">
    <div class="demographics-table-cell">
      <div style="border-style: solid; border-width: 0px 0px 1px 0px;">
        <table id="names">
          <tr>
            <td id="gender-icon-container"></td>
            <td id="client-name"></td>
            <td id="client-dob"></td>
          </tr>
        </table>
      </div>

      <table id="demographics-addresses">
        <tr>
          <th>Ancestry district:&nbsp;</th>
          <td id="ancestry-district"></td>
          <th>Ancestry TA:&nbsp;</th>
          <td id="ancestry-ta"></td>
          <th>Ancestry village:&nbsp;</th>
          <td id="ancestry-village"></td>
        </tr>

        <tr>
          <th>Current district:&nbsp;</th>
          <td id="current-district"></td>
          <th>Current TA:&nbsp;</th>
          <td id="current-ta"></td>
          <th>Current village:&nbsp;</th>
          <td id="current-village"></td>
        </tr>
      </table>
    </div>
  </div>
</div>

<div class="info-table"></div>
<div
  class="modal fade"
  tabindex="-1"
  role="dialog"
  aria-labelledby="mySmallModalLabel"
  aria-hidden="true"
  id="mi-modal"
  style="width: 60%; margin-left:20%;margin-right: 20%; margin-top: 20%;"
>
  <div class="modal-dialog modal-sm">
    <div class="modal-content" style="margin: 0; ">
      <div class="modal-header">
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
        <h1 class="modal-title" id="myModalLabel">
          Patient Has Died, are you sure you want to continue?
        </h1>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="button green"
          id="modal-btn-si"
          style="float:left; text-align: center; width: 100px;"
        >
          Yes
        </button>
        <button
          type="button"
          class="button red"
          id="modal-btn-no"
          style="width: 100px;"
        >
          No
        </button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  tabindex="-1"
  role="dialog"
  aria-labelledby="mySmallModalLabel"
  aria-hidden="true"
  id="mi-modal-2"
  style="width: 60%; margin-left:20%;margin-right: 20%; margin-top: 20%;"
>
  <div class="modal-dialog modal-sm">
    <div class="modal-content" style="margin: 0; ">
      <div class="modal-header">
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
        <h1 class="modal-title" id="myModalLabel" style="text-align:center;">
          Patient Not Found. Please scan again or search by name
        </h1>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="button red"
          id="modal-btn-si-2"
          style="float:right; text-align: center; width: 100px;"
        >
          Okay
        </button>
      </div>
    </div>
  </div>
</div>
<div class="buttonsDIV">
  <button
    class="red"
    style="float: left; margin-left: 10px;"
    onmousedown="location='/'"
  >
    Cancel
  </button>
  <button class="blue" onmousedown="getFilingNumberType()" 
    style="float: right;" id="continue">Continue</button>
</div>

<!-- Modal -->
<div class="modal fade" id="confirm-VL" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">
        <h1 style="text-align: center" class="text-uppercase">Patient has a high viral load,  Please take immediate action! </h1>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger btn-lg" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  buildInfoBoxes();

  function finish(id) {
    sessionStorage.patientID = id;
    if (patientDead == true) {
      $("#mi-modal").modal("show");
      var modalConfirm = function(callback) {
        $("#continue").on("click", function() {
          $("#mi-modal").modal("show");
        });

        $("#modal-btn-si").on("click", function() {
          callback(true);
          $("#mi-modal").modal("hide");
        });

        $("#modal-btn-no").on("click", function() {
          callback(false);
          $("#mi-modal").modal("hide");
        });
      };

      modalConfirm(function(confirm) {
        if (confirm) {
          window.location.href =
            "/views/patient_dashboard.html?patient_id=" + id;
        } else {
          $("#mi-modal").modal("hide");

          window.location.href = "/";
        }
      });
    } else {

      /* .......... filing ............... */
      if(user_filing_numbers == true){
        try {
          var fnumber = document.getElementById('filing-number').innerHTML;
        }catch(q) {
          var fnumber = '';
        }
       
        var re = new RegExp(dormantPrefix);
        if(fnumber.match(re)){
          var tstMessageBar = document.createElement('div');
          var p = document.createElement('p');
          p.setAttribute('style','text-align: center;font-size: 35px;');
          p.innerHTML = "Activate dormant #:<p />";
          p.innerHTML += fnumber;
          tstMessageBar.appendChild(p);
          
          var noBTN = document.createElement('button');
          noBTN.innerHTML = "<span>No</span>";
          noBTN.setAttribute('class', 'button blue navButton filing-number-btn');
          noBTN.setAttribute('onmousedown','closeFilingNumPopUP();');
          tstMessageBar.appendChild(noBTN);

          var yesBTN = document.createElement('button');
          yesBTN.innerHTML = "<span>Yes</span>";
          yesBTN.setAttribute('class', 'button red navButton filing-number-btn');
          yesBTN.style = 'right: 140px;'; 
          yesBTN.setAttribute('onmousedown','archivePatient();');
          tstMessageBar.appendChild(yesBTN);
          tstMessageBar.setAttribute('id', 'address-confirmation');

          var cover = document.createElement('div');
          cover.setAttribute('id','address-confirmation-cover');
          var bdy = document.getElementsByTagName('body')[0];
          bdy.appendChild(cover);
          bdy.appendChild(tstMessageBar);
          tstMessageBar.style = 'display: inline; height: 30%; width: 50%; left: 30%;top: 10%;';
          cover.style = 'display: inline;';

          return;
        }
      }
      /* .......... filing end ............... */

      sessionStorage.showWeightChart = true;
      sessionStorage.showPregnantQuestion = true;
      nextEncounter(sessionStorage.patientID, sessionStorage.programID);
    }
  }

  function noPatient() {
    $("#mi-modal-2").modal("show");
    var modalConfirm = function(callback) {
      $("#continue").on("click", function() {
        $("#mi-modal-2").modal("show");
      });

      $("#modal-btn-si-2").on("click", function() {
        callback(true);
        $("#mi-modal-2").modal("hide");
      });

      $("#modal-btn-no-2").on("click", function() {
        callback(false);
        $("#mi-modal-2").modal("hide");
      });
    };

    modalConfirm(function(confirm) {
      if (confirm) {
        window.location.href = "/";
      }
    });
  }

  function formatIdentifier(identifier) {
    if (identifier.length == 6) {
      var id = identifier.substring(0, 3);
      id += "-" + identifier.substring(3, 6);
      identifier = id;
    } else if (identifier.length == 10) {
      var id = identifier.substring(0, 5);
      id += "-" + identifier.substring(5, 10);
      identifier = id;
    } else if (identifier.length == 13) {
      var id = identifier.substring(0, 5);
      id += "-" + identifier.substring(5, 9);
      id += "-" + identifier.substring(9, 13);
      identifier = id;
    }

    return identifier;
  }

function getFilingNumberType() {
  finish(sessionStorage.patientID);
}

function isFilingNumberDormant(filingNumber) {
  return filingNumber.match(/archived/ig);
}

function patientDoesNotHaveFilingNumber(filingNumber) {
  return filingNumber === "N/A";
}

function redirectToFilingNumberPage(patientId) {
  var url = '/apps/ART/views/filing_number/filing_number_management.html?patient_id=' + patientId;
  document.location = url;
}

function calculateMonthsOnART(art_start_date) {
  var year = art_start_date.split('/')[2];
  var month = art_start_date.split('/')[1];
  var day = art_start_date.split('/')[0];
  art_start_date = (year + '-' + month + '-' + day);
                               
  var date1 = new Date(sessionStorage.sessionDate);
  var date2 = new Date(moment(art_start_date).format('YYYY-MM-DD'));
  return dateDiffInMonths(date1, date2);
}            

function dateDiffInMonths(d2, d1) {
  var d1Y = d1.getFullYear();
  var d2Y = d2.getFullYear();
  var d1M = d1.getMonth();
  var d2M = d2.getMonth();

  return (d2M+12*d2Y)-(d1M+12*d1Y);
}

var current_person_addresses;

function checkAddressValidity(addresses) {
  current_person_addresses = addresses;
  getCellPhone(sessionStorage.patientID, addresses);
}

function displayCurrentInfo(addresses, cell_number_details) {  
  var bd = document.getElementsByTagName('body')[0];
 
  var current_district = (!addresses == false ? addresses[0]['state_province'] : null);
  var current_ta = (!addresses == false ? addresses[0]['township_division'] : null);
  var current_village = (!addresses == false ? addresses[0]['city_village'] : null);

  var cell_number;
  if(cell_number_details)
    cell_number = cell_number_details.value;
  
  var popUpBox = document.createElement('div');
  popUpBox.setAttribute('id','address-confirmation');
  bd.appendChild(popUpBox);

  var popUpBoxCover = document.createElement('div');
  popUpBoxCover.setAttribute('id','address-confirmation-cover');
  bd.appendChild(popUpBoxCover);

  var table = document.createElement('table');
  table.setAttribute('id','address-confirmation-table');
  table.style.fontSize = '26px';
  popUpBox.appendChild(table);
  
  var tr = document.createElement('tr');
  var th = document.createElement('th');
  th.setAttribute('colspan','2');
  tr.appendChild(th);
  th.innerHTML = "Confirm client's current address and phone number"
  table.appendChild(tr);

  var tr = document.createElement('tr');
  var td = document.createElement('td');
  td.innerHTML = 'Current district:';
  tr.appendChild(td);
  var td = document.createElement('td');
  td.innerHTML = current_district;
  tr.appendChild(td);
  table.appendChild(tr);

  var tr = document.createElement('tr');
  var td = document.createElement('td');
  td.innerHTML = 'Current TA:';
  tr.appendChild(td);
  var td = document.createElement('td');
  td.innerHTML = current_ta;
  tr.appendChild(td);
  table.appendChild(tr);

  var tr = document.createElement('tr');
  var td = document.createElement('td');
  td.innerHTML = 'Current village:';
  tr.appendChild(td);
  var td = document.createElement('td');
  td.innerHTML = current_village;
  tr.appendChild(td);
  table.appendChild(tr);

  var tr = document.createElement('tr');
  var td = document.createElement('td');
  td.innerHTML = 'Cell phone #:';
  tr.appendChild(td);
  var td = document.createElement('td');
  td.innerHTML = cell_number;
  tr.appendChild(td);
  table.appendChild(tr);


  var btnContainer = document.createElement('div');
  btnContainer.setAttribute('id','address-confirmation-buttons');
  popUpBox.appendChild(btnContainer);

  var cancelBtn = document.createElement('button');
  cancelBtn.setAttribute('class','address-confirmation-button');
  cancelBtn.innerHTML = 'Update information';
  cancelBtn.setAttribute('id','blue-btn');
  cancelBtn.setAttribute('onmousedown','updateAddress('+patient_id+');');
  btnContainer.appendChild(cancelBtn);

  var cancelBtn = document.createElement('button');
  cancelBtn.setAttribute('class','address-confirmation-button');
  cancelBtn.innerHTML = 'Information OK';
  cancelBtn.setAttribute('id','green-btn');
  cancelBtn.setAttribute('onmousedown','confirmAddress();');
  btnContainer.appendChild(cancelBtn);





  popUpBoxCover.style = 'display: inline;';  
  popUpBox.style = 'display: inline;';  
}

function getCellPhone(patient_id, addresses) {
  
  var url = apiProtocol + "://" + apiURL + ":" + apiPort;
  url += "/api/v1/person_attributes?person_id=" + patient_id;
  url += "&person_attribute_type_id=12";

  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
      var obj = JSON.parse(this.responseText);
      if(sessionStorage.programID === "1") {
        validateContactDetails(addresses, obj);  
      }
      
    }
  };
  xhttp.open("GET", url, true);
  xhttp.setRequestHeader("Authorization",sessionStorage.getItem("authorization"));
  xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send();
}

function validateContactDetails(addresses, cell_number_details) {

  if(!addresses && !cell_number_details) {
    displayCurrentInfo([], null);
    return;
  }else if(!addresses && cell_number_details) {
    displayCurrentInfo([], cell_number_details);
    return;
  }

  if(addresses) {
    var date_created = moment(addresses[0].date_created).format('YYYY-MM-DD');
    date_created = moment(date_created);
    current_date = moment();
    var yrs = current_date.diff(date_created, 'years');

    if(yrs >= 1) {
      displayCurrentInfo(addresses, cell_number_details);
    }

  }else{
    displayCurrentInfo([], cell_number_details);
  }
}

function confirmAddress() {
  var bd = document.getElementsByTagName('body')[0];
  var div = document.getElementById('address-confirmation');
  bd.removeChild(div);
  var div = document.getElementById('address-confirmation-cover');
  bd.removeChild(div);

  var url = apiProtocol + "://" + apiURL + ":" + apiPort;
  url += "/api/v1/people/" + patient_id;

  if(!current_person_addresses)
    return;

  
  var parameters = JSON.stringify({
    home_district: current_person_addresses[0].address2, 
    home_traditional_authority: current_person_addresses[0].county_district, 
    home_village: current_person_addresses[0].neighborhood_cell, 
    current_region: "", 
    current_district: current_person_addresses[0].state_province, 
    current_traditional_authority: current_person_addresses[0].township_division, 
    current_village: current_person_addresses[0].city_village, 
    id: sessionStorage.patientID, 
    person: {}  
  });

  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
      var obj = JSON.parse(this.responseText);
      console.log(parameters);
    }
  };
  xhttp.open("PUT", url, true);
  xhttp.setRequestHeader("Authorization",sessionStorage.getItem("authorization"));
  xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send(parameters);
}

function updateAddress(patient_id) {
  
  var scanned_patient_id = "";
  var location_url = 'patient/edit_demographics.html?patient_id=' + patient_id;
  location_url += "&scanned_patient_id=" + patient_id;

  location = location_url;
}

function populateNextTask(patient_id) {
  
  var url = apiProtocol + "://" + apiURL + ":" + apiPort;
  url += "/api/v1/workflows/"+ sessionStorage.programID +"/" + patient_id;
  url += "?date=" + sessionStorage.sessionDate;


  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
      var obj = JSON.parse(this.responseText);
      document.getElementById('nextTask').innerHTML = obj.name;
    }
  };
  xhttp.open("GET", url, true);
  xhttp.setRequestHeader("Authorization",sessionStorage.getItem("authorization"));
  xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send();
}

var activePrefix;
var dormantPrefix;
var user_filing_numbers = false;

function filingNumberPrefix() {
  var href = window.location.href;
  var url = new URL(href);
  primary_patient_id  = url.searchParams.get("primary_patient_id");
  secondary_patient_id = url.searchParams.get("secondary_patient_id");
  primary_id = url.searchParams.get("new_identifier");
  secondary_id = url.searchParams.get("old_identifier");

  var url = apiProtocol + "://" + apiURL + ":" + apiPort + "/api/v1";
  url += '/global_properties?property=filing.number.prefix';
  
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 ) {
      if (this.status == 201 || this.status == 200 ) {
        var obj = JSON.parse(this.responseText);
        var prefix = obj['filing.number.prefix'].split(',');
        activePrefix = prefix[0];
        dormantPrefix = prefix[1];
      }
    }
 };
 xhttp.open("GET", url, true);
 xhttp.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
 xhttp.setRequestHeader('Content-type', "application/json");
 xhttp.send();
}

function userFilingNumbers() {
  var href = window.location.href;
  var url = new URL(href);
  primary_patient_id  = url.searchParams.get("primary_patient_id");
  secondary_patient_id = url.searchParams.get("secondary_patient_id");
  primary_id = url.searchParams.get("new_identifier");
  secondary_id = url.searchParams.get("old_identifier");

  var url = apiProtocol + "://" + apiURL + ":" + apiPort + "/api/v1";
  url += '/global_properties?property=use.filing.numbers';
  
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 ) {
      if (this.status == 201 || this.status == 200 ) {
        var obj = JSON.parse(this.responseText);
        var use_fn = obj['use.filing.numbers'];
        try {
          user_filing_numbers = (use_fn == 'true' ? true : false);
        }catch(e) {
          user_filing_numbers = false;
        }
      }
    }
 };
 xhttp.open("GET", url, true);
 xhttp.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
 xhttp.setRequestHeader('Content-type', "application/json");
 xhttp.send();
}

function archivePatient() {
  var bdy = document.getElementsByTagName('body')[0]
  var e = document.getElementById('address-confirmation');
  bdy.removeChild(e);

  sessionStorage.showWeightChart = true;
  sessionStorage.showPregnantQuestion = true;
  var url = '/apps/ART/views/filing_number/filing_number_management.html?'
  url += 'patient_id=' + sessionStorage.patientID;
  document.location = url;
}

function closeFilingNumPopUP() {
  /*var bdy = document.getElementsByTagName('body')[0]
  var e = document.getElementById('address-confirmation');
  var e2 = document.getElementById('address-confirmation-cover');
  bdy.removeChild(e);
  bdy.removeChild(e2);*/

  sessionStorage.showWeightChart = true;
  sessionStorage.showPregnantQuestion = true;
  nextEncounter(sessionStorage.patientID, sessionStorage.programID);
}

userFilingNumbers();
filingNumberPrefix();
</script>
<script src="/assets/js/show.lab.orders.js"></script>
